<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>RO Calculator</title>
    <script src="https://unpkg.com/vue"></script>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/linq"></script>

    <!-- <style type="text/css">
        #equipinput {
            display: inline;
            padding: 0 20px;
        }
    </style> -->
    <style>
        .el-row {
            margin-bottom: 4px;
        }

        .el-col {
            border-radius: 4px;
        }

        .bg-purple-dark {
            background: #99a9bf;
        }

        .bg-purple {
            background: #d3dce6;
        }

        .bg-purple-light {
            background: #e5e9f2;
        }

        .grid-content {
            border-radius: 4px;
            min-height: 36px;
        }

        .row-bg {
            padding: 10px 0;
            background-color: #f9fafc;
        }

        .effectline {
            line-height: 3;
            margin: auto;
        }

        .boxborder {
            padding: 5px 5px;
            border: 1px solid #d7dae2;
            border-radius: 4px;
            min-height: 100px;
        }
    </style>
</head>

<body>
    <el-container>
        <el-header>
        </el-header>
        <el-main id="equipment">
            <el-dialog :visible.sync="EquipEffectDialogVisible" @close="CloseEffectDialogue" title="選擇效果">
                <el-row :gutter="6">
                    <el-col :span="11">
                        <div class="grid-content bg-purple">
                            <el-select value-key="id" v-model="effectdialogue.EffectType" v-on:change="onSelectedDrug"
                                placeholder="選擇效果">
                                <el-option v-for="item in effecttypelist" :key="item.id" :label="item.label"
                                    :value="item">
                                </el-option>
                            </el-select>
                        </div>
                    </el-col>
                    <el-col :span="8">
                        <div class="grid-content bg-purple-light">
                            <el-input v-model="effectdialogue.EffectNumber" v-on:keyup.enter.native="AddEffect"
                                placeholder="效果參數">
                            </el-input>
                        </div>
                    </el-col>
                    <el-col :span="5">
                        <div>
                            <el-button v-on:click="AddEffect" icon="el-icon-circle-plus-outline" type="success" plain>
                            </el-button>
                        </div>
                    </el-col>
                </el-row>
            </el-dialog>

            <el-row>
                <el-col :span="24">
                    <div class="effectline grid-content bg-purple-dark" type="flex" align="middle" justify="center">
                        <span>RO Calculator</span>
                    </div>
                </el-col>
            </el-row>
            <el-row>
                <el-col :span="8">
                    <div class="boxborder">
                        <div class="Item bg-purple-light" v-for="(item,eqindex) in equipspartlist">
                            <div class="Equipment">
                                <el-row class="effectline" type="flex" align="middle">
                                    <el-col :span="4">
                                        <div>
                                            <span>{{item.id}}</span>
                                        </div>
                                    </el-col>
                                    <el-col :span="15">
                                        <div>
                                            <el-input v-model="equipspartlist[eqindex].equipname" placeholder="裝備名稱">
                                            </el-input>
                                        </div>
                                    </el-col>
                                    <el-col :span="5">
                                        <el-button v-on:click="OpenEffectDialogue(eqindex)"
                                            icon="el-icon-circle-plus-outline" type="success" plain>
                                        </el-button>
                                    </el-col>
                                </el-row>
                                <el-row>
                                    <el-col :span="24">
                                        <el-row>
                                            <div v-for="(item, index) in equipspartlist[eqindex].effectlist"
                                                v-bind:key="item.effecttypelist">
                                                <el-row class="bg-purple" type="flex" align="middle" justify="end">
                                                    <el-col :span="6">
                                                        <span
                                                            class="effectline EffectType">{{ item.EffectType.label }}</span>
                                                    </el-col>
                                                    <el-col :span="2">
                                                        <span>+</span>
                                                    </el-col>
                                                    <el-col :span="4">
                                                        <span
                                                            class="effectline EffectNumber">{{ item.EffectNumber }}</span>
                                                    </el-col>
                                                    <el-col :span="5">
                                                        <el-button class="effectline"
                                                            v-on:click="RemoveEffect(eqindex, index)"
                                                            icon="el-icon-remove-outline" type="success" plain>
                                                        </el-button>
                                                    </el-col>
                                                </el-row>
                                            </div>
                                        </el-row>
                                    </el-col>
                                </el-row>
                            </div>
                        </div>
                    </div>
                </el-col>

                <el-col :span="8">
                    <div style=" box-shadow: 0 2px 12px 0 rgba(0, 0, 0, 0.1)">

                        <div class="boxborder">
                        </div>
                    </div>
                </el-col>
            </el-row>

        </el-main>
        <el-footer>
        </el-footer>
    </el-container>



    <script>
        evue = new Vue({
            el: '#equipment',
            data: {
                EquipSelectId: '',
                equipspartlist: [
                    { id: 'helm', equipname: '', effectlist: [] },
                    { id: 'armor', equipname: '', effectlist: [] },
                    { id: 'weaponl', equipname: '', effectlist: [] },
                    { id: 'weaponr', equipname: '', effectlist: [] },
                    { id: 'robe', equipname: '', effectlist: [] },
                    { id: 'shoes', equipname: '', effectlist: [] },
                    { id: 'acc1', equipname: '', effectlist: [] },
                    { id: 'acc2', equipname: '', effectlist: [] },
                ],
                effecttypelist: [
                    { label: 'ATK', id: 'ATK', totalvalue: '' },
                    { label: 'ATK%', id: 'ATKPercent', totalvalue: '' },
                    { label: 'Matk', id: 'Matk', totalvalue: '' },
                    { label: 'Matk%', id: 'MatkPercent', totalvalue: '' },
                    { label: '種族%', id: 'RacePercent', totalvalue: '' },
                    { label: '體型%', id: 'SizePercent', totalvalue: '' },
                    { label: '屬性%', id: 'ElementalPercent', totalvalue: '' },
                    { label: '階級%', id: 'LevelPercent', totalvalue: '' },
                    { label: '爆傷%', id: 'CriDamagePercent', totalvalue: '' },
                    { label: '遠傷%', id: 'RangedDamagePercent', totalvalue: '' },
                    { label: '無視防禦%', id: 'BypassDEFPercent', totalvalue: '' }
                ],
                EquipEffectDialogVisible: false,
                effectdialogue: {
                    EffectType: '',
                    EffectNumber: ''
                }
            },
            methods: {
                CombineAttribute() {

                    console.log("------");
                    var ef = Enumerable
                        .from(this.equipspartlist)
                        .where(function(e){ return e.effectlist.find(x=> x.EffectType.id == 'ATK'); })
                        //.select("value, index => value.effectlist.filter(x => x.EffectType.id == 'ATK')")
                        .select(function(x){
                            var xx = x.effectlist.filter(x => x.EffectType.id == 'ATK')
                            return Number(xx[0].EffectNumber);
                        })
                        .sum();
                    console.log(ef);
                },
                AddEffect() {
                    if (this.effectdialogue.EffectNumber === '') { return; }

                    if (this.equipspartlist[this.EquipSelectId].effectlist.length > 0) {
                        var index = this.equipspartlist[this.EquipSelectId].effectlist.findIndex(x => this.effectdialogue.EffectType.label === x.EffectType.label);

                        if (index > -1) {
                            this.equipspartlist[this.EquipSelectId].effectlist[index] = {
                                EffectNumber: this.effectdialogue.EffectNumber,
                                EffectType: this.effectdialogue.EffectType
                            };
                            console.log("CoverEffect: " + this.equipspartlist[this.EquipSelectId].effectlist[index].EffectType + " /" + this.equipspartlist[this.EquipSelectId].effectlist[index].EffectNumber);

                            this.$set(this.equipspartlist[this.EquipSelectId].effectlist,
                                index,
                                {
                                    EffectNumber: this.equipspartlist[this.EquipSelectId].effectlist[index].EffectNumber,
                                    EffectType: this.equipspartlist[this.EquipSelectId].effectlist[index].EffectType
                                })
                            this.effectdialogue.EffectNumber = '';
                            this.EquipEffectDialogVisible = false;
                            this.CombineAttribute();
                            return;
                        }
                    }
                    this.equipspartlist[this.EquipSelectId].effectlist.push({
                        EffectNumber: this.effectdialogue.EffectNumber,
                        EffectType: this.effectdialogue.EffectType,
                    })
                    console.log("AddEffect: " + this.effectdialogue.EffectType + " /" + this.effectdialogue.EffectNumber);
                    this.effectdialogue.EffectNumber = '';
                    this.EquipEffectDialogVisible = false;
                    this.CombineAttribute();
                },
                RemoveEffect(eqindex, index) {
                    console.log("RemoveEffect: [" + eqindex + "] " + index);
                    //var index = this.equipspartlist[eqindex].indexOf(item)
                    if (index >= 0) {
                        this.equipspartlist[eqindex].effectlist.splice(index, 1)
                    }
                },
                onSelectedDrug(item) {
                    console.log("onSelectedDrug " + item.label);
                },
                OpenEffectDialogue(eqindex) {
                    console.log("OpenDialogue " + eqindex);
                    this.EquipEffectDialogVisible = true;
                    this.EquipSelectId = eqindex;
                },
                CloseEffectDialogue() {
                    this.EquipSelectId = '';
                }
            },
            mounted() {
                console.log("mounted");
                this.effectdialogue.EffectType = this.effecttypelist[0];
                var jsonArray = [
                    { "user": { "id": 100, "screen_name": "d_linq" }, "text": "to objects" },
                    { "user": { "id": 130, "screen_name": "c_bill" }, "text": "g" },
                    { "user": { "id": 155, "screen_name": "b_mskk" }, "text": "kabushiki kaisha" },
                    { "user": { "id": 301, "screen_name": "a_xbox" }, "text": "halo reach" }
                ]
                // ["b_mskk:kabushiki kaisha", "c_bill:g", "d_linq:to objects"]
                var queryResult = Enumerable.from(jsonArray)
                    .where(function (x) { return x.user.id < 200 })
                    .orderBy(function (x) { return x.user.screen_name })
                    .select(function (x) { return x.user.screen_name + ':' + x.text })
                    .toArray();
                queryResult.forEach(function (i) {
                    console.log(i);
                });

            }
        })
    </script>

    <body>

</html>